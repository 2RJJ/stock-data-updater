name: Update Wave59 Yahoo Data

on:
  schedule:
    - cron: '0 0 * * 1-5'   # Daily at 00:00 UTC (full daily bars)
    - cron: '*/15 9-16 * * 1-5'  # Every 15 min, 9AMâ€“4PM ET
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode'
        required: true
        default: '15min'
        type: choice
        options: ['daily', '15min']

permissions:
  contents: read

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas

      - name: Run update
        run: |
          MODE="${{ inputs.mode || '15min' }}"
          if [[ "$MODE" == "daily" ]]; then
            python update_data.py --mode daily --years 5
          else
            python update_data.py --mode 15min
          fi

      - name: Transfer to Secondary Mac
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SECONDARY_HOST }}
          username: ${{ secrets.SECONDARY_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "Wave59_Yahoo_Data/"
          target: "/Users/ronaldjones/Library/Mobile Documents/com~apple~CloudDocs/Documents/Wave59/Data/Yahoo/"
          overwrite: true

      - name: Confirm
        run: |
          ssh ${{ secrets.SECONDARY_USER }}@${{ secrets.SECONDARY_HOST }} \
            "find ~/Library/Mobile\\ Documents/com~apple~CloudDocs/Documents/Wave59/Data/Yahoo -name '*_15m.csv' -exec ls -la {} \\; | head -5"
