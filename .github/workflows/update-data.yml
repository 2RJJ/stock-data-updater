#!/usr/bin/env python3
import argparse
import sys
from pathlib import Path
import pandas as pd
import yfinance as yf
from datetime import datetime, timedelta
import time

# =============== ARGUMENTS ===============
parser = argparse.ArgumentParser(description="Yahoo Finance → Wave59 data downloader")
parser.add_argument('--mode', choices=['daily', '15min'], required=True)
parser.add_argument('--years', type=int, default=20, help="Years of daily history (daily mode only)")
parser.add_argument('--output-dir', type=str, 
                    default="/Users/ronjones/Documents/YahooFinance")
args = parser.parse_args()

OUTPUT_DIR = Path(args.output_dir)
OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

print(f"Saving all files to: {OUTPUT_DIR}")
print(f"Mode: {args.mode.upper()} – Started at {datetime.now():%Y-%m-%d %H:%M:%S}\n")

# =============== YOUR TICKER LIST (edit anytime) ===============
TICKERS = [
    "SPY", "QQQ", "IWM", "DIA",
    "AAPL", "MSFT", "GOOGL", "AMZN", "NVDA", "META", "TSLA",
    "ES=F", "NQ=F", "YM=F", "RTY=F",
    "^VIX", "^TNX", "^VXN",
    "GLD", "SLV", "USO", "TLT",
    # ← add/remove anything you need here
]

failed = []

for ticker in TICKERS:
    try:
        print(f"{ticker.ljust(10)} → downloading... ", end="")
        t = yf.Ticker(ticker)

        if args.mode == "daily":
            start = (datetime.today() - timedelta(days=args.years * 365)).strftime("%Y-%m-%d")
            df = t.history(start=start, interval="1d")
            filename = OUTPUT_DIR / f"{ticker}_daily.csv"
        else:  # 15min
            df = t.history(period="60d", interval="15m")
            filename = OUTPUT_DIR / f"{ticker}_15m.csv"

        if df.empty:
            print("EMPTY")
            failed.append(ticker)
            continue

        df = df.drop(columns=["Dividends", "Stock Splits"], errors="ignore")
        df.to_csv(filename)
        print(f"✓ {len(df):,} rows")

        time.sleep(0.5)  # be nice to Yahoo
    except Exception as e:
        print(f"✗ FAILED ({e})")
        failed.append(ticker)

print("\n" + "="*60)
print(f"Finished {datetime.now():%Y-%m-%d %H:%M:%S}")
print(f"Success: {len(TICKERS)-len(failed)} / {len(TICKERS)}")
if failed:
    print("Failed:", ", ".join(failed))
print("="*60)
